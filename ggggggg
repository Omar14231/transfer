-- خدمات روبلكس
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")

-- اللاعب المحلي
local localPlayer = Players.LocalPlayer
local playerGui = localPlayer:WaitForChild("PlayerGui")

-- إنشاء واجهة المستخدم
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ChatInterface"
screenGui.ResetOnSpawn = false
screenGui.Parent = playerGui

-- إناء الخلفية الرئيسي
local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0, 300, 0, 400)
mainFrame.Position = UDim2.new(0, 20, 0.5, -200)
mainFrame.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
mainFrame.BorderSizePixel = 0
mainFrame.ClipsDescendants = true
mainFrame.Visible = false
mainFrame.Parent = screenGui

-- زوايا مستديرة
local uiCorner = Instance.new("UICorner")
uiCorner.CornerRadius = UDim.new(0, 8)
uiCorner.Parent = mainFrame

-- ظل
local uiShadow = Instance.new("UIStroke")
uiShadow.Color = Color3.fromRGB(20, 20, 20)
uiShadow.Thickness = 2
uiShadow.Parent = mainFrame

-- شريط العنوان
local titleBar = Instance.new("Frame")
titleBar.Name = "TitleBar"
titleBar.Size = UDim2.new(1, 0, 0, 40)
titleBar.Position = UDim2.new(0, 0, 0, 0)
titleBar.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
titleBar.BorderSizePixel = 0
titleBar.Parent = mainFrame

-- زوايا مستديرة للشريط العلوي فقط
local titleCorner = Instance.new("UICorner")
titleCorner.CornerRadius = UDim.new(0, 8)
titleCorner.Parent = titleBar

-- نص العنوان
local titleLabel = Instance.new("TextLabel")
titleLabel.Name = "TitleLabel"
titleLabel.Size = UDim2.new(1, -10, 1, 0)
titleLabel.Position = UDim2.new(0, 10, 0, 0)
titleLabel.BackgroundTransparency = 1
titleLabel.Text = "الدردشة"
titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
titleLabel.TextScaled = true
titleLabel.Font = Enum.Font.GothamBold
titleLabel.TextXAlignment = Enum.TextXAlignment.Right
titleLabel.Parent = titleBar

-- منطقة الرسائل
local messagesFrame = Instance.new("ScrollingFrame")
messagesFrame.Name = "MessagesFrame"
messagesFrame.Size = UDim2.new(1, -10, 1, -100)
messagesFrame.Position = UDim2.new(0, 5, 0, 45)
messagesFrame.BackgroundTransparency = 1
messagesFrame.BorderSizePixel = 0
messagesFrame.ScrollBarThickness = 4
messagesFrame.ScrollBarImageColor3 = Color3.fromRGB(100, 100, 100)
messagesFrame.AutomaticCanvasSize = Enum.AutomaticSize.Y
messagesFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
messagesFrame.Parent = mainFrame

-- قائمة الرسائل
local messagesLayout = Instance.new("UIListLayout")
messagesLayout.Name = "MessagesLayout"
messagesLayout.Padding = UDim.new(0, 5)
messagesLayout.SortOrder = Enum.SortOrder.LayoutOrder
messagesLayout.Parent = messagesFrame

-- منطقة الإدخال
local inputFrame = Instance.new("Frame")
inputFrame.Name = "InputFrame"
inputFrame.Size = UDim2.new(1, -10, 0, 40)
inputFrame.Position = UDim2.new(0, 5, 1, -50)
inputFrame.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
inputFrame.BorderSizePixel = 0
inputFrame.Parent = mainFrame

-- زوايا مستديرة لمنطقة الإدخال
local inputCorner = Instance.new("UICorner")
inputCorner.CornerRadius = UDim.new(0, 6)
inputCorner.Parent = inputFrame

-- حقل النص
local textBox = Instance.new("TextBox")
textBox.Name = "ChatTextBox"
textBox.Size = UDim2.new(1, -10, 1, -10)
textBox.Position = UDim2.new(0, 5, 0, 5)
textBox.BackgroundTransparency = 1
textBox.Text = "اكتب رسالة هنا..."
textBox.TextColor3 = Color3.fromRGB(200, 200, 200)
textBox.TextScaled = true
textBox.Font = Enum.Font.Gotham
textBox.TextXAlignment = Enum.TextXAlignment.Right
textBox.ClearTextOnFocus = false
textBox.Parent = inputFrame

-- زر الإرسال
local sendButton = Instance.new("TextButton")
sendButton.Name = "SendButton"
sendButton.Size = UDim2.new(0, 60, 0, 30)
sendButton.Position = UDim2.new(1, -65, 0.5, -15)
sendButton.BackgroundColor3 = Color3.fromRGB(0, 120, 215)
sendButton.BorderSizePixel = 0
sendButton.Text = "إرسال"
sendButton.TextColor3 = Color3.fromRGB(255, 255, 255)
sendButton.TextScaled = true
sendButton.Font = Enum.Font.GothamBold
sendButton.Parent = inputFrame

-- زوايا مستديرة لزر الإرسال
local sendCorner = Instance.new("UICorner")
sendCorner.CornerRadius = UDim.new(0, 6)
sendCorner.Parent = sendButton

-- زر فتح/إغلاق الدردشة
local toggleButton = Instance.new("ImageButton")
toggleButton.Name = "ToggleButton"
toggleButton.Size = UDim2.new(0, 50, 0, 50)
toggleButton.Position = UDim2.new(0, 20, 0, 20)
toggleButton.BackgroundColor3 = Color3.fromRGB(0, 120, 215)
toggleButton.BorderSizePixel = 0
toggleButton.Image = "rbxassetid://14184355227" -- استبدل بمعرف الصورة الخاص بك
toggleButton.Parent = screenGui

-- زوايا مستديرة للزر
local toggleCorner = Instance.new("UICorner")
toggleCorner.CornerRadius = UDim.new(0, 25)
toggleCorner.Parent = toggleButton

-- ظل للزر
local toggleShadow = Instance.new("UIStroke")
toggleShadow.Color = Color3.fromRGB(20, 20, 20)
toggleShadow.Thickness = 2
toggleShadow.Parent = toggleButton

-- إنشاء RemoteEvents للاتصال بين اللاعبين
local chatEvent
if RunService:IsClient() then
    if ReplicatedStorage:FindFirstChild("ChatEvent") then
        chatEvent = ReplicatedStorage:FindFirstChild("ChatEvent")
    else
        chatEvent = Instance.new("RemoteEvent")
        chatEvent.Name = "ChatEvent"
        chatEvent.Parent = ReplicatedStorage
    end
end

-- متغيرات
local chatOpen = false
local messageDuration = 15 -- مدة عرض الرسالة فوق رأس اللاعب
local activeMessageBillboards = {}

-- وظيفة إنشاء رسالة في القائمة
local function createMessageInChat(sender, message)
    local messageFrame = Instance.new("Frame")
    messageFrame.Name = "MessageFrame"
    messageFrame.Size = UDim2.new(1, 0, 0, 40)
    messageFrame.BackgroundTransparency = 1
    messageFrame.Parent = messagesFrame
    
    local senderLabel = Instance.new("TextLabel")
    senderLabel.Name = "SenderLabel"
    senderLabel.Size = UDim2.new(0.3, 0, 0.5, 0)
    senderLabel.Position = UDim2.new(0.7, 0, 0, 0)
    senderLabel.BackgroundTransparency = 1
    senderLabel.Text = sender .. ":"
    senderLabel.TextColor3 = Color3.fromRGB(0, 170, 255)
    senderLabel.TextScaled = true
    senderLabel.Font = Enum.Font.GothamBold
    senderLabel.TextXAlignment = Enum.TextXAlignment.Right
    senderLabel.Parent = messageFrame
    
    local messageLabel = Instance.new("TextLabel")
    messageLabel.Name = "MessageLabel"
    messageLabel.Size = UDim2.new(0.65, 0, 1, 0)
    messageLabel.Position = UDim2.new(0, 5, 0, 0)
    messageLabel.BackgroundTransparency = 1
    messageLabel.Text = message
    messageLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    messageLabel.TextScaled = true
    messageLabel.Font = Enum.Font.Gotham
    messageLabel.TextXAlignment = Enum.TextXAlignment.Right
    messageLabel.TextWrapped = true
    messageLabel.Parent = messageFrame
    
    -- التمرير إلى الأسفل لرؤية أحدث الرسائل
    messagesFrame.CanvasPosition = Vector2.new(0, messagesFrame.AbsoluteCanvasSize.Y)
end

-- وظيفة عرض الرسالة فوق رأس اللاعب
local function showMessageAboveHead(player, message)
    -- إزالة الرسالة السابقة إن وجدت
    if activeMessageBillboards[player] then
        activeMessageBillboards[player]:Destroy()
        activeMessageBillboards[player] = nil
    end
    
    -- إنشاء BillboardGui لعرض الرسالة فوق رأس اللاعب
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "ChatMessage"
    billboard.Size = UDim2.new(0, 200, 0, 50)
    billboard.StudsOffset = Vector3.new(0, 3, 0)
    billboard.AlwaysOnTop = true
    billboard.Adornee = player.Character and player.Character:FindFirstChild("Head")
    billboard.Parent = player.Character and player.Character:FindFirstChild("Head")
    
    -- إناء للرسالة
    local messageFrame = Instance.new("Frame")
    messageFrame.Name = "MessageFrame"
    messageFrame.Size = UDim2.new(1, 0, 1, 0)
    messageFrame.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    messageFrame.BackgroundTransparency = 0.2
    messageFrame.BorderSizePixel = 0
    messageFrame.Parent = billboard
    
    -- زوايا مستديرة
    local messageCorner = Instance.new("UICorner")
    messageCorner.CornerRadius = UDim.new(0, 8)
    messageCorner.Parent = messageFrame
    
    -- نص الرسالة
    local messageLabel = Instance.new("TextLabel")
    messageLabel.Name = "MessageLabel"
    messageLabel.Size = UDim2.new(1, -10, 1, -10)
    messageLabel.Position = UDim2.new(0, 5, 0, 5)
    messageLabel.BackgroundTransparency = 1
    messageLabel.Text = message
    messageLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    messageLabel.TextScaled = true
    messageLabel.Font = Enum.Font.Gotham
    messageLabel.TextWrapped = true
    messageLabel.Parent = messageFrame
    
    -- حفظ المرجع لإزالته لاحقًا
    activeMessageBillboards[player] = billboard
    
    -- إزالة الرسالة بعد المدة المحددة
    delay(messageDuration, function()
        if billboard and billboard.Parent then
            billboard:Destroy()
            activeMessageBillboards[player] = nil
        end
    end)
end

-- وظيفة إرسال الرسالة
local function sendMessage()
    local message = textBox.Text
    if message and message ~= "" and message ~= "اكتب رسالة هنا..." then
        -- إرسال الرسالة للخادم
        chatEvent:FireServer(message)
        
        -- عرض الرسالة في واجهة المستخدم المحلية
        createMessageInChat(localPlayer.Name, message)
        showMessageAboveHead(localPlayer, message)
        
        -- مسح حقل النص
        textBox.Text = ""
    end
end

-- وظيفة فتح/إغلاق الدردشة
local function toggleChat()
    chatOpen = not chatOpen
    mainFrame.Visible = chatOpen
    
    if chatOpen then
        -- تأثير عند الفتح
        mainFrame.Size = UDim2.new(0, 0, 0, 0)
        local tweenInfo = TweenInfo.new(0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out)
        local tween = TweenService:Create(mainFrame, tweenInfo, {Size = UDim2.new(0, 300, 0, 400)})
        tween:Play()
        
        -- التركيز على حقل النص
        textBox:CaptureFocus()
    else
        -- تأثير عند الإغلاق
        local tweenInfo = TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.In)
        local tween = TweenService:Create(mainFrame, tweenInfo, {Size = UDim2.new(0, 0, 0, 0)})
        tween:Play()
    end
end

-- استقبال الرسائل من اللاعبين الآخرين
chatEvent.OnClientEvent:Connect(function(sender, message)
    if sender ~= localPlayer then
        createMessageInChat(sender.Name, message)
        
        -- عرض الرسالة فوق رأس اللاعب المرسل
        if sender.Character then
            showMessageAboveHead(sender, message)
        end
    end
end)

-- أحداث النقر
toggleButton.MouseButton1Click:Connect(toggleChat)
sendButton.MouseButton1Click:Connect(sendMessage)

-- حدث عند الضغط على Enter في حقل النص
textBox.FocusLost:Connect(function(enterPressed)
    if enterPressed then
        sendMessage()
    end
end)

-- تكييف الواجهة مع مختلف الأجهزة
local function adaptToDevice()
    if UserInputService.TouchEnabled then
        -- تكبير العناصر للأجهزة اللوحية والهواتف
        toggleButton.Size = UDim2.new(0, 70, 0, 70)
        mainFrame.Size = UDim2.new(0, 350, 0, 450)
        textBox.TextSize = 18
    end
end

-- تكييف الواجهة عند البدء
adaptToDevice()

print("تم تحميل واجهة الدردشة بنجاح!")
