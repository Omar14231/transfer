-- Script (يضع في ServerScriptService)
local Players = game:GetService("Players")
local TextService = game:GetService("TextService")
local RunService = game:GetService("RunService")

-- إعدادات الشات
local CHAT_DURATION = 15 -- مدة ظهور الرسالة فوق الرأس (ثانية)
local MAX_MESSAGE_LENGTH = 100 -- أقصى طول للرسالة

-- تخزين الرسائل والواجهات
local playerGuis = {}
local chatMessages = {}

-- وظيفة إنشاء واجهة الشات للاعب
function createChatGUI(player)
    local playerGui = player:WaitForChild("PlayerGui")
    
    -- إنشاء ScreenGui
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "GlobalChat"
    screenGui.Parent = playerGui
    
    -- الإطار الرئيسي (مصغر للجوال)
    local mainFrame = Instance.new("Frame")
    mainFrame.Size = UDim2.new(0.9, 0, 0.7, 0) -- 90% عرض, 70% ارتفاع
    mainFrame.Position = UDim2.new(0.05, 0, 0.15, 0) -- في الأعلى
    mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
    mainFrame.BackgroundTransparency = 0.1
    mainFrame.BorderSizePixel = 0
    mainFrame.Parent = screenGui
    
    -- زوايا مستديرة
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 10)
    corner.Parent = mainFrame
    
    -- ظل
    local stroke = Instance.new("UIStroke")
    stroke.Color = Color3.fromRGB(100, 100, 200)
    stroke.Thickness = 2
    stroke.Parent = mainFrame
    
    -- عنوان الشات
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Size = UDim2.new(1, 0, 0, 35)
    titleLabel.Position = UDim2.new(0, 0, 0, 0)
    titleLabel.BackgroundColor3 = Color3.fromRGB(50, 50, 80)
    titleLabel.Text = "💬 الشات"
    titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    titleLabel.TextSize = 16
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.Parent = mainFrame
    
    -- زوايا العنوان
    local titleCorner = Instance.new("UICorner")
    titleCorner.CornerRadius = UDim.new(0, 10)
    titleCorner.Parent = titleLabel
    
    -- زر إخفاء القائمة
    local closeButton = Instance.new("TextButton")
    closeButton.Size = UDim2.new(0, 25, 0, 25)
    closeButton.Position = UDim2.new(1, -30, 0, 5)
    closeButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
    closeButton.Text = "X"
    closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    closeButton.TextSize = 14
    closeButton.Font = Enum.Font.GothamBold
    closeButton.Parent = titleLabel
    
    local closeCorner = Instance.new("UICorner")
    closeCorner.CornerRadius = UDim.new(0, 6)
    closeCorner.Parent = closeButton
    
    -- منطقة السجل (أصغر للجوال)
    local scrollFrame = Instance.new("ScrollingFrame")
    scrollFrame.Size = UDim2.new(1, -10, 1, -120)
    scrollFrame.Position = UDim2.new(0, 5, 0, 40)
    scrollFrame.BackgroundTransparency = 1
    scrollFrame.BorderSizePixel = 0
    scrollFrame.ScrollBarThickness = 4
    scrollFrame.Parent = mainFrame
    
    -- قائمة الرسائل
    local messageList = Instance.new("UIListLayout")
    messageList.Padding = UDim.new(0, 3)
    messageList.Parent = scrollFrame
    
    -- زر الكتابة السريعة (زر أحمر)
    local quickChatButton = Instance.new("TextButton")
    quickChatButton.Size = UDim2.new(1, -10, 0, 30)
    quickChatButton.Position = UDim2.new(0, 5, 1, -75)
    quickChatButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
    quickChatButton.Text = "🔴 اكتب هنا"
    quickChatButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    quickChatButton.TextSize = 12
    quickChatButton.Font = Enum.Font.GothamBold
    quickChatButton.Parent = mainFrame
    
    local quickChatCorner = Instance.new("UICorner")
    quickChatCorner.CornerRadius = UDim.new(0, 6)
    quickChatCorner.Parent = quickChatButton
    
    -- منطقة الكتابة (مصغرة)
    local inputFrame = Instance.new("Frame")
    inputFrame.Size = UDim2.new(1, -10, 0, 35)
    inputFrame.Position = UDim2.new(0, 5, 1, -35)
    inputFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
    inputFrame.BorderSizePixel = 0
    inputFrame.Parent = mainFrame
    
    local inputCorner = Instance.new("UICorner")
    inputCorner.CornerRadius = UDim.new(0, 6)
    inputCorner.Parent = inputFrame
    
    -- حقل النص (مصغر)
    local textBox = Instance.new("TextBox")
    textBox.Size = UDim2.new(1, -60, 1, -6)
    textBox.Position = UDim2.new(0, 5, 0, 3)
    textBox.BackgroundTransparency = 1
    textBox.Text = ""
    textBox.PlaceholderText = "اكتب رسالتك..."
    textBox.TextColor3 = Color3.fromRGB(255, 255, 255)
    textBox.TextSize = 12
    textBox.Font = Enum.Font.Gotham
    textBox.TextXAlignment = Enum.TextXAlignment.Left
    textBox.Parent = inputFrame
    
    -- زر الإرسال (مصغر)
    local sendButton = Instance.new("TextButton")
    sendButton.Size = UDim2.new(0, 50, 1, -6)
    sendButton.Position = UDim2.new(1, -55, 0, 3)
    sendButton.BackgroundColor3 = Color3.fromRGB(0, 100, 200)
    sendButton.Text = "إرسال"
    sendButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    sendButton.TextSize = 12
    sendButton.Font = Enum.Font.GothamBold
    sendButton.Parent = inputFrame
    
    local buttonCorner = Instance.new("UICorner")
    buttonCorner.CornerRadius = UDim.new(0, 5)
    buttonCorner.Parent = sendButton
    
    -- حفظ البيانات
    playerGuis[player] = {
        Gui = screenGui,
        MainFrame = mainFrame,
        ScrollFrame = scrollFrame,
        TextBox = textBox,
        SendButton = sendButton,
        CloseButton = closeButton,
        QuickChatButton = quickChatButton,
        IsVisible = true
    }
    
    -- أحداث الأزرار
    sendButton.MouseButton1Click:Connect(function()
        sendMessage(player, textBox.Text)
        textBox.Text = ""
    end)
    
    textBox.FocusLost:Connect(function(enterPressed)
        if enterPressed then
            sendMessage(player, textBox.Text)
            textBox.Text = ""
        end
    end)
    
    closeButton.MouseButton1Click:Connect(function()
        toggleChatVisibility(player)
    end)
    
    quickChatButton.MouseButton1Click:Connect(function()
        openQuickChatPopup(player)
    end)
    
    return playerGuis[player]
end

-- وظيفة تبديل إظهار/إخفاء الشات
function toggleChatVisibility(player)
    local guiData = playerGuis[player]
    if not guiData then return end
    
    guiData.IsVisible = not guiData.IsVisible
    guiData.MainFrame.Visible = guiData.IsVisible
    
    if not guiData.IsVisible then
        createShowChatButton(player)
    else
        removeShowChatButton(player)
    end
end

-- وظيفة إنشاء زر إظهار الشات عندما يكون مخفياً
function createShowChatButton(player)
    local guiData = playerGuis[player]
    if not guiData or not guiData.Gui then return end
    
    removeShowChatButton(player)
    
    local showButton = Instance.new("TextButton")
    showButton.Size = UDim2.new(0, 60, 0, 60)
    showButton.Position = UDim2.new(0, 20, 0, 50)
    showButton.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
    showButton.Text = "💬"
    showButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    showButton.TextSize = 24
    showButton.Font = Enum.Font.GothamBold
    showButton.Parent = guiData.Gui
    
    local showCorner = Instance.new("UICorner")
    showCorner.CornerRadius = UDim.new(0, 12)
    showCorner.Parent = showButton
    
    showButton.MouseButton1Click:Connect(function()
        toggleChatVisibility(player)
    end)
    
    guiData.ShowButton = showButton
end

-- وظيفة إزالة زر إظهار الشات
function removeShowChatButton(player)
    local guiData = playerGuis[player]
    if guiData and guiData.ShowButton then
        guiData.ShowButton:Destroy()
        guiData.ShowButton = nil
    end
end

-- وظيفة فتح نافذة الكتابة السريعة (مصغرة للجوال)
function openQuickChatPopup(player)
    local guiData = playerGuis[player]
    if not guiData then return end
    
    -- نافذة الكتابة السريعة (مصغرة)
    local popupFrame = Instance.new("Frame")
    popupFrame.Size = UDim2.new(0.8, 0, 0, 120)
    popupFrame.Position = UDim2.new(0.1, 0, 0.3, 0)
    popupFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 60)
    popupFrame.BorderSizePixel = 0
    popupFrame.Parent = guiData.Gui
    
    local popupCorner = Instance.new("UICorner")
    popupCorner.CornerRadius = UDim.new(0, 10)
    popupCorner.Parent = popupFrame
    
    local popupStroke = Instance.new("UIStroke")
    popupStroke.Color = Color3.fromRGB(255, 50, 50)
    popupStroke.Thickness = 3
    popupStroke.Parent = popupFrame
    
    -- عنوان النافذة
    local popupTitle = Instance.new("TextLabel")
    popupTitle.Size = UDim2.new(1, 0, 0, 30)
    popupTitle.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
    popupTitle.Text = "🔴 اكتب رسالتك"
    popupTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
    popupTitle.TextSize = 14
    popupTitle.Font = Enum.Font.GothamBold
    popupTitle.Parent = popupFrame
    
    local titleCorner = Instance.new("UICorner")
    titleCorner.CornerRadius = UDim.new(0, 10)
    titleCorner.Parent = popupTitle
    
    -- حقل النص السريع
    local quickTextBox = Instance.new("TextBox")
    quickTextBox.Size = UDim2.new(1, -10, 0, 40)
    quickTextBox.Position = UDim2.new(0, 5, 0, 35)
    quickTextBox.BackgroundColor3 = Color3.fromRGB(60, 60, 80)
    quickTextBox.Text = ""
    quickTextBox.PlaceholderText = "اكتب أي شيء هنا..."
    quickTextBox.TextColor3 = Color3.fromRGB(255, 255, 255)
    quickTextBox.TextSize = 12
    quickTextBox.Font = Enum.Font.Gotham
    quickTextBox.TextWrapped = true
    quickTextBox.Parent = popupFrame
    
    local textCorner = Instance.new("UICorner")
    textCorner.CornerRadius = UDim.new(0, 6)
    textCorner.Parent = quickTextBox
    
    -- زر الإرسال السريع
    local quickSendButton = Instance.new("TextButton")
    quickSendButton.Size = UDim2.new(0, 80, 0, 25)
    quickSendButton.Position = UDim2.new(0.5, -40, 1, -30)
    quickSendButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
    quickSendButton.Text = "إرسال"
    quickSendButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    quickSendButton.TextSize = 12
    quickSendButton.Font = Enum.Font.GothamBold
    quickSendButton.Parent = popupFrame
    
    local quickCorner = Instance.new("UICorner")
    quickCorner.CornerRadius = UDim.new(0, 6)
    quickCorner.Parent = quickSendButton
    
    -- أحداث الأزرار
    quickSendButton.MouseButton1Click:Connect(function()
        if string.len(quickTextBox.Text) > 0 then
            sendMessage(player, quickTextBox.Text)
            popupFrame:Destroy()
        end
    end)
    
    quickTextBox.FocusLost:Connect(function(enterPressed)
        if enterPressed and string.len(quickTextBox.Text) > 0 then
            sendMessage(player, quickTextBox.Text)
            popupFrame:Destroy()
        end
    end)
    
    -- إعطاء التركيز لحقل النص
    quickTextBox:CaptureFocus()
end

-- وظيفة إرسال رسالة
function sendMessage(sender, message)
    if string.len(message) == 0 or string.len(message) > MAX_MESSAGE_LENGTH then
        return
    end
    
    -- تنظيف النص من الرموز الخطيرة
    message = string.gsub(message, "[<>]", "")
    
    -- إضافة الرسالة للطلاب (الرسالة الجديدة في النهاية)
    table.insert(chatMessages, {
        Player = sender,
        Message = message,
        Timestamp = os.time()
    })
    
    -- عرض الرسالة فوق رأس المرسل
    showMessageAboveHead(sender, message)
    
    -- تحديث واجهات جميع اللاعبين
    updateAllChatGuis()
    
    -- بث الرسالة لجميع اللاعبين
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= sender then
            showMessageAboveHead(sender, message)
        end
    end
end

-- وظيفة عرض الرسالة فوق الرأس
function showMessageAboveHead(player, message)
    local character = player.Character
    if not character then return end
    
    local head = character:FindFirstChild("Head")
    if not head then return end
    
    -- إزالة الرسائل القديمة
    for _, obj in pairs(head:GetChildren()) do
        if obj.Name == "ChatMessage" then
            obj:Destroy()
        end
    end
    
    -- إنشاء BillboardGui للرسالة
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "ChatMessage"
    billboard.Size = UDim2.new(0, 200, 0, 40)
    billboard.StudsOffset = Vector3.new(0, 2, 0)
    billboard.AlwaysOnTop = true
    billboard.Parent = head
    
    -- إطار الرسالة
    local messageFrame = Instance.new("Frame")
    messageFrame.Size = UDim2.new(1, 0, 1, 0)
    messageFrame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    messageFrame.BackgroundTransparency = 0.3
    messageFrame.Parent = billboard
    
    local frameCorner = Instance.new("UICorner")
    frameCorner.CornerRadius = UDim.new(0, 6)
    frameCorner.Parent = messageFrame
    
    -- نص الرسالة
    local messageLabel = Instance.new("TextLabel")
    messageLabel.Size = UDim2.new(1, -8, 1, -8)
    messageLabel.Position = UDim2.new(0, 4, 0, 4)
    messageLabel.BackgroundTransparency = 1
    messageLabel.Text = player.Name .. ": " .. message
    messageLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    messageLabel.TextSize = 10
    messageLabel.Font = Enum.Font.Gotham
    messageLabel.TextWrapped = true
    messageLabel.Parent = messageFrame
    
    -- إزالة الرسالة بعد المدة المحددة
    delay(CHAT_DURATION, function()
        if billboard and billboard.Parent then
            billboard:Destroy()
        end
    end)
end

-- وظيفة تحديث واجهات الشات للجميع
function updateAllChatGuis()
    for player, guiData in pairs(playerGuis) do
        if player and player.Parent and guiData.IsVisible then
            updateChatGUI(player)
        end
    end
end

-- وظيفة تحديث واجهة الشات للاعب
function updateChatGUI(player)
    local guiData = playerGuis[player]
    if not guiData then return end
    
    local scrollFrame = guiData.ScrollFrame
    scrollFrame:ClearAllChildren()
    
    -- عرض الرسائل من الأقدم إلى الأحدث (القديم في الأعلى، الجديد في الأسفل)
    for i = 1, #chatMessages do
        local messageData = chatMessages[i]
        if messageData then
            createMessageLabel(scrollFrame, messageData.Player, messageData.Message, messageData.Timestamp, i)
        end
    end
    
    -- التمرير للأسفل لرؤية أحدث الرسائل
    scrollFrame.CanvasSize = UDim2.new(0, 0, 0, scrollFrame.UIListLayout.AbsoluteContentSize.Y)
    scrollFrame.CanvasPosition = Vector2.new(0, scrollFrame.CanvasSize.Y.Offset)
end

-- وظيفة إنشاء تسمية للرسالة (مصغرة للجوال)
function createMessageLabel(parent, player, message, timestamp, index)
    local messageFrame = Instance.new("Frame")
    messageFrame.Size = UDim2.new(1, 0, 0, 0)
    messageFrame.BackgroundTransparency = 1
    messageFrame.AutomaticSize = Enum.AutomaticSize.Y
    messageFrame.Parent = parent
    
    local messageLayout = Instance.new("UIListLayout")
    messageLayout.Parent = messageFrame
    
    -- اسم اللاعب
    local playerLabel = Instance.new("TextLabel")
    playerLabel.Size = UDim2.new(1, 0, 0, 16)
    playerLabel.BackgroundTransparency = 1
    playerLabel.Text = player.Name
    playerLabel.TextColor3 = Color3.fromRGB(100, 200, 255)
    playerLabel.TextSize = 10
    playerLabel.Font = Enum.Font.GothamBold
    playerLabel.TextXAlignment = Enum.TextXAlignment.Left
    playerLabel.Parent = messageFrame
    
    -- نص الرسالة
    local textLabel = Instance.new("TextLabel")
    textLabel.Size = UDim2.new(1, 0, 0, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.Text = message
    textLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    textLabel.TextSize = 11
    textLabel.Font = Enum.Font.Gotham
    textLabel.TextWrapped = true
    textLabel.TextXAlignment = Enum.TextXAlignment.Left
    textLabel.AutomaticSize = Enum.AutomaticSize.Y
    textLabel.Parent = messageFrame
    
    -- الوقت
    local timeLabel = Instance.new("TextLabel")
    timeLabel.Size = UDim2.new(1, 0, 0, 12)
    timeLabel.BackgroundTransparency = 1
    timeLabel.Text = os.date("%H:%M", timestamp)
    timeLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
    timeLabel.TextSize = 8
    timeLabel.Font = Enum.Font.Gotham
    timeLabel.TextXAlignment = Enum.TextXAlignment.Left
    timeLabel.Parent = messageFrame
end

-- عند دخول لاعب جديد
function onPlayerAdded(player)
    -- الانتظار حتى تحميل الشخصية
    player.CharacterAdded:Connect(function(character)
        wait(1)
        createChatGUI(player)
        updateChatGUI(player)
    end)
    
    -- إذا كانت الشخصية موجودة مسبقاً
    if player.Character then
        createChatGUI(player)
        updateChatGUI(player)
    end
end

-- عند مغادرة لاعب
function onPlayerRemoving(player)
    if playerGuis[player] then
        playerGuis[player].Gui:Destroy()
        playerGuis[player] = nil
    end
end

-- الاستماع للأحداث
Players.PlayerAdded:Connect(onPlayerAdded)
Players.PlayerRemoving:Connect(onPlayerRemoving)

-- تهيئة اللاعبين الموجودين
for _, player in pairs(Players:GetPlayers()) do
    onPlayerAdded(player)
end

print("✅ نظام الشات للجوال يعمل! جميع اللاعبين يمكنهم المحادثة")
